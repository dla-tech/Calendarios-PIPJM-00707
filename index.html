<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Cartelera semanal PIPJM</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Config externo editable -->
<script src="./config.js"></script>

<style>
  :root{
    --bg:#0b1421; --card:#0f1b2c; --text:#e6eefc; --muted:#93a4bf; --accent:#16a34a; --warn:#ef4444;
    --fs:22px; --fs-big:64px; --fs-h1:42px; --fs-h2:28px;
    --shadow: 0 20px 50px rgba(0,0,0,.35);
    --sleep-opacity: 1; /* se ajusta desde config (dim) */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:500 var(--fs)/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--text); background: var(--bg);
    display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:min(1200px,96vw); margin:auto; padding:18px}
  .row{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px}
  .card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:18px; box-shadow:var(--shadow)}
  h1{margin:.1em 0 .2em; font-size:var(--fs-h1); letter-spacing:.3px}
  h2{margin:.1em 0 .5em; font-size:var(--fs-h2); color:#cfe0ff}
  .muted{color:var(--muted)}
  .big{font-size:var(--fs-big); font-weight:800; letter-spacing:.5px}
  .time{font-size:calc(var(--fs) + 6px); font-weight:800}
  .tag{display:inline-block; padding:4px 10px; border-radius:999px; background:#122742; color:#cfe0ff; font-weight:800; font-size:16px}
  .grid{display:grid; gap:10px}
  .ev{border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px}
  .row2{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center}
  .qr{width:260px; height:260px; border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden}
  .qr img{max-width:100%; max-height:100%}
  .clock{display:flex; gap:12px; align-items:baseline}
  .dot{width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px}
  .ok{background:var(--accent)} .bad{background:var(--warn)}
  .footer{margin-top:10px; font-size:16px; color:#9fb3d4}
  .center{display:flex; align-items:center; justify-content:center}
  .marquee{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .banner{display:flex; align-items:center; justify-content:center; height:62vh}
  .banner img{max-width:100%; max-height:100%; border-radius:14px; box-shadow:var(--shadow)}
  .titleCenter{font-weight:900; text-align:center; font-size: calc(var(--fs-h1) + 6px)}
  .subCenter{color:var(--muted); text-align:center}
  .status{position:fixed; left:12px; bottom:10px; font:600 12px system-ui; color:#9fb3d4}

  /* === Overlay Sleep (nuevo) === */
  #sleepOverlay{
    position:fixed; inset:0; z-index:99999;
    background:#000; opacity:var(--sleep-opacity);
    display:none; align-items:center; justify-content:center;
    color:#fff; text-align:center; padding:24px;
  }
  #sleepOverlay.active{ display:flex }
  #sleepOverlay .msg{ font:700 28px/1.25 system-ui; opacity:.9; }
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <!-- Columna izquierda -->
    <div class="card" id="leftCard">
      <div class="clock">
        <span id="liveDot" class="dot ok"></span>
        <div id="now" class="big">--:--</div>
        <div id="date" class="muted" style="font-size:calc(var(--fs) + 2px)"></div>
      </div>

      <div id="stage">
        <!-- Aquí se pinta: portada, texto, o evento actual -->
      </div>

      <div class="footer" id="footNote">Actualiza solo — semana actual. Cambia tarjeta cada 12s.</div>
    </div>

    <!-- Columna derecha: listado del día -->
    <div class="card">
      <h2 id="listTitle">Eventos del día</h2>
      <div id="list" class="grid"></div>
    </div>
  </div>
</div>

<div class="status" id="status">ICS OK</div>

<!-- Overlay de Sleep (nuevo) -->
<div id="sleepOverlay"><div class="msg"></div></div>

<script>
/* ======== Helpers ======== */
const C = window.MONITOR_CONFIG;
function applyTheme(){
  const r = document.documentElement;
  r.style.setProperty('--bg', C.theme.background);
  r.style.setProperty('--card', C.theme.card);
  r.style.setProperty('--text', C.theme.text);
  r.style.setProperty('--muted', C.theme.muted);
  r.style.setProperty('--accent', C.theme.accent);
  r.style.setProperty('--warn', C.theme.warn);
  r.style.setProperty('--shadow', C.theme.shadow);
  r.style.setProperty('--fs', C.theme.fontSize+'px');
  r.style.setProperty('--fs-big', C.theme.bigClock+'px');
  r.style.setProperty('--fs-h1', C.theme.h1+'px');
  r.style.setProperty('--fs-h2', C.theme.h2+'px');
}
applyTheme();

const fmt = new Intl.DateTimeFormat('es-PR',{weekday:'long', day:'2-digit', month:'long', year:'numeric', timeZone:C.timeZone});
const fmtTime = new Intl.DateTimeFormat('es-PR',{hour:'numeric', minute:'2-digit', hour12:true, timeZone:C.timeZone});
const toTZ = d => new Date(d.toLocaleString('en-US',{timeZone:C.timeZone}));
const startOfDay = d => (d=new Date(d), d.setHours(0,0,0,0), d);
const addDays = (d,n)=> (d=new Date(d), d.setDate(d.getDate()+n), d);
const sameDay = (a,b)=>{a=toTZ(a);b=toTZ(b);return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()};
const unfold = txt => txt.replace(/(?:\r\n|\n)[ \t]/g,'');
const pad2 = n => n<10?'0'+n:''+n;

function hm(d){
  return fmtTime.format(toTZ(d)).toLowerCase()
    .replace(/\s/g,'').replace('a. m.','am').replace('p. m.','pm');
}
function dateLong(d){ const s = fmt.format(toTZ(d)); return s.charAt(0).toUpperCase()+s.slice(1); }

function qrFor(url){
  if(!url) return '';
  const u = encodeURIComponent(url);
  return `https://api.qrserver.com/v1/create-qr-code/?size=${C.qrSize}x${C.qrSize}&data=${u}`;
}
function isTemple(text){
  if(!text) return false;
  const t = String(text).toLowerCase();
  return C.templeKeywords.some(k => t.includes(k.toLowerCase()));
}
function firstUrl(...vals){
  for(const v of vals){
    if (v && /^https?:\/\//i.test(v)) return v;
  }
  return '';
}
function parseDescFields(desc){
  const out = { preacher:'', manager:'', extra:'' };
  if(!desc) return out;
  const lines = String(desc).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const ln of lines){
    const mP = C.fieldsFromDescription.preacher && ln.match(C.fieldsFromDescription.preacher);
    if (mP && !out.preacher) out.preacher = (mP[2]||'').trim();
    const mM = C.fieldsFromDescription.manager && ln.match(C.fieldsFromDescription.manager);
    if (mM && !out.manager) out.manager = (mM[2]||'').trim();
  }
  out.extra = lines.filter(ln=>!/(predicador|predica|encargad[oa])\s*:/i.test(ln)).join(' · ');
  return out;
}

/* ======== ICS ======== */
function parseICS(txt){
  txt = unfold(txt);
  const blocks = txt.split(/BEGIN:VEVENT/).slice(1).map(b=>'BEGIN:VEVENT'+b.split('END:VEVENT')[0]);
  const out = [];
  for(const b of blocks){
    const get = (k)=>{ const m=b.match(new RegExp('^'+k+'(?:;[^:\\n]*)?:(.*)$','mi')); return m?m[1].trim():''; };
    const when = (()=>{ // DTSTART/DTEND
      const m = b.match(/^DTSTART([^:\n]*)?:([^\n]+)$/mi); if(!m) return null;
      const p=(m[1]||'').toUpperCase(); const v=m[2].trim();
      const dOnly=v.match(/^(\d{4})(\d{2})(\d{2})$/);
      const dt=v.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/);
      const toDt = (Y,M,D,hh,mm,ss, z)=> z ? new Date(Date.UTC(+Y,+M-1,+D,+hh,+mm,+ss))
                                           : new Date(Date.UTC(+Y,+M-1,+D,+hh+4,+mm,+ss));
      if(/VALUE=DATE/.test(p) && dOnly){ const [_,Y,M,D]=dOnly; return {start:new Date(Date.UTC(+Y,+M-1,+D,4,0,0)), end:new Date(Date.UTC(+Y,+M-1,+D,4,0,0))}; }
      if(dt){ const [_,Y,M,D,hh,mm,ss,Z]=dt; return {start:toDt(Y,M,D,hh,mm,ss,Z), end:null}; }
      if(dOnly){ const [_,Y,M,D]=dOnly; return {start:new Date(Date.UTC(+Y,+M-1,+D,4,0,0)), end:null}; }
      return null;
    })();
    if(!when) continue;
    const ev = {
      start: when.start,
      end:   (()=>{ // intenta DTEND (si existe)
        const m=b.match(/^DTEND[^:]*:([^\n]+)$/mi);
        if(!m) return null;
        const v=m[1].trim();
        const dt=v.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/);
        const dOnly=v.match(/^(\d{4})(\d{2})(\d{2})$/);
        if(dt){ const [_,Y,M,D,hh,mm,ss,Z]=dt; return Z?new Date(Date.UTC(+Y,+M-1,+D,+hh,+mm,+ss)):new Date(Date.UTC(+Y,+M-1,+D,+hh+4,+mm,+ss)); }
        if(dOnly){ const [_,Y,M,D]=dOnly; return new Date(Date.UTC(+Y,+M-1,+D,4,0,0)); }
        return null;
      })(),
      summary:  get('SUMMARY'),
      location: get('LOCATION'),
      url:      get('URL'),
      desc:     get('DESCRIPTION')
    };
    out.push(ev);
  }
  out.sort((a,b)=> a.start - b.start);
  return out;
}

function groupByDayWeek(events, baseDate){
  const pr = toTZ(baseDate);
  // domingo como inicio de semana
  const sun = startOfDay(addDays(pr, -pr.getDay()));
  const weekDays = [...Array(7)].map((_,i)=> addDays(sun,i));
  const map = new Map(weekDays.map(d=>[startOfDay(d).getTime(), []]));
  for(const ev of events){
    for(const d of weekDays){
      if (sameDay(ev.start, d)){ map.get(startOfDay(d).getTime()).push(ev); break; }
    }
  }
  for(const [k,list] of map){ list.sort((a,b)=> a.start - b.start); }
  return {sun, days: weekDays, map};
}

/* ======== Estado ======== */
let state = {
  allEvents: [],
  week: null,
  dayIdx: 0,
  evIdx: 0,
  slideTimer: null,
  stageSeq: [],  // secuencia de tarjetas (intro/banner, intro/text, …, outro/banner, outro/text)
  stageIdx: 0
};

function buildStageSequence(){
  const seq = [];
  // Intro
  if (C.intro.bannerUrl) seq.push({type:'banner', url:C.intro.bannerUrl});
  if (C.intro.text)      seq.push({type:'text',   text:C.intro.text});
  // Semana (7 días)
  for (let i=0;i<7;i++) seq.push({type:'day', dayOffset:i});
  // Outro
  if (C.outro.bannerUrl) seq.push({type:'banner', url:C.outro.bannerUrl});
  if (C.outro.text)      seq.push({type:'text',   text:C.outro.text});
  state.stageSeq = seq;
  state.stageIdx = 0;
}

/* ======== Render ======== */
function renderClock(){
  const now = new Date();
  document.getElementById('now').textContent = fmtTime.format(toTZ(now));
  document.getElementById('date').textContent= dateLong(now);
}
function renderList(dayTs){
  const box = document.getElementById('list'); box.innerHTML='';
  const list = state.week.map.get(dayTs) || [];
  if(!list.length){
    box.innerHTML = `<div class="muted">Sin eventos para este día</div>`;
    return;
  }
  for(const ev of list){
    const div = document.createElement('div');
    div.className='ev';
    const end = ev.end ? ' – ' + hm(ev.end) : '';
    div.innerHTML = `
      <div class="time">${hm(ev.start)}${end}</div>
      <div style="font-weight:800">${ev.summary||'Evento'}</div>
      ${ev.location? `<div class="muted">${ev.location}</div>`:''}
    `;
    box.appendChild(div);
  }
}

function toDateFromHm(baseDate, hmStr){
  // "HH:MM" -> Date ese día
  if(!hmStr) return null;
  const [H,M] = hmStr.split(':').map(n=>parseInt(n,10));
  const d = startOfDay(baseDate);
  d.setHours(H-4, M||0, 0, 0); // ajustar a UTC+0 (Puerto Rico UTC-4 aprox)
  return d;
}

function paintStage(){
  renderClock();

  const now = toTZ(new Date());
  const weekSun = startOfDay(addDays(now, -now.getDay()));

  // cambio de semana: domingo a la hora configurada
  if (now.getDay()===C.weekRolloverDay && now.getHours()>=C.weekRolloverHour && !sameDay(state.week.sun, weekSun)){
    rebuildWeek(); // reagrupa y reinicia secuencia
  }

  const stage = state.stageSeq[state.stageIdx % state.stageSeq.length];
  const holder = document.getElementById('stage');
  const listTitle = document.getElementById('listTitle');

  if (stage.type === 'banner'){
    holder.innerHTML = `
      <div class="banner"><img src="${stage.url}" alt="Banner" /></div>
      <div class="footer muted center" style="margin-top:6px"> </div>`;
    listTitle.textContent = 'Eventos del día';
    renderList(startOfDay(toTZ(new Date())).getTime());
    return;
  }

  if (stage.type === 'text'){
    const rangeText = (()=> {
      const s = state.week.days[0], e = state.week.days[6];
      return `${dateLong(s)} — ${dateLong(e)}`;
    })();
    holder.innerHTML = `
      <div class="center" style="height:62vh; flex-direction:column; gap:10px">
        <div class="titleCenter">${stage.text}</div>
        <div class="subCenter">${rangeText}</div>
      </div>`;
    listTitle.textContent = 'Eventos del día';
    renderList(startOfDay(toTZ(new Date())).getTime());
    return;
  }

  if (stage.type === 'day'){
    const day = state.week.days[stage.dayOffset];
    const dayKey = startOfDay(day).getTime();
    const list = state.week.map.get(dayKey) || [];
    listTitle.textContent= 'Eventos de ' + dateLong(day);

    // Si no hay eventos ICS, usa defaults del config (si existen)
    const weekday = toTZ(day).getDay(); // 0=domingo
    let items = list.slice();
    if (!items.length && C.defaultsByWeekday[weekday] && C.defaultsByWeekday[weekday].length){
      items = C.defaultsByWeekday[weekday].map(d => ({
        start: d.start ? toDateFromHm(day,d.start) : day,
        end:   d.end   ? toDateFromHm(day,d.end)   : null,
        summary: d.title || 'Evento',
        location: d.where || '',
        url: '',
        desc: d.desc || ''
      }));
    }

    if(!items.length){
      document.getElementById('stage').innerHTML = `
        <h1 id="dayTitle">${dateLong(day)}</h1>
        <div class="grid"><div class="ev">
          <div class="row2"><div>
            <div class="tag">—</div>
            <h2 class="marquee">Sin eventos</h2>
            <div class="muted"> </div>
            <div class="muted" style="margin-top:6px"></div>
          </div><div class="qr center"></div></div></div></div>`;
      renderList(dayKey);
      return;
    }

    // Escoge el ítem “actual” (rotamos por hora dentro del día)
    const ev = items[state.evIdx % items.length];

    const hasPinUrl = firstUrl(ev.url, ev.location);
    const temple = isTemple(ev.location) || (!hasPinUrl && ev.location && isTemple(ev.location));
    const showQr = hasPinUrl && !temple;

    const df = parseDescFields(ev.desc);

    const end = ev.end ? ' – ' + hm(ev.end) : '';
    const place = showQr ? 'Pin disponible (escanea el QR)' : (ev.location || (temple?'Templo':''));

    const preacher = df.preacher ? `<div class="muted">Predicador: ${df.preacher}</div>` : '';
    const manager  = df.manager  ? `<div class="muted">Encargado: ${df.manager}</div>`  : '';
    const extra    = df.extra    ? `<div class="muted">${df.extra}</div>`               : '';

    document.getElementById('stage').innerHTML = `
      <h1 id="dayTitle">${dateLong(day)}</h1>
      <div class="grid">
        <div class="ev">
          <div class="row2">
            <div>
              <div class="tag">${ev.start ? hm(ev.start) : ''}${end}</div>
              <h2 class="marquee">${ev.summary || 'Evento'}</h2>
              <div class="muted">${place}</div>
              ${preacher}${manager}${extra ? `<div class="muted" style="margin-top:6px">${extra}</div>`:''}
            </div>
            <div class="qr center">${ showQr ? `<img src="${qrFor(hasPinUrl)}" alt="QR localización">` : '' }</div>
          </div>
        </div>
      </div>
    `;
    renderList(dayKey);
    return;
  }
}

function advance(){
  const stage = state.stageSeq[state.stageIdx % state.stageSeq.length];
  if(stage.type==='day'){
    // rota eventos internos del día
    const day = state.week.days[stage.dayOffset];
    const dayKey = startOfDay(day).getTime();
    const list = state.week.map.get(dayKey) || [];
    const weekday = toTZ(day).getDay();
    const hasDefaults = C.defaultsByWeekday[weekday] && C.defaultsByWeekday[weekday].length;

    const total = list.length ? list.length : (hasDefaults ? C.defaultsByWeekday[weekday].length : 1);
    if (total>1 && state.evIdx < total-1){
      state.evIdx++;
      paintStage();
      return;
    }
    state.evIdx = 0; // resetea y avanza de tarjeta
  }
  state.stageIdx = (state.stageIdx + 1) % state.stageSeq.length;
  paintStage();
}

/* ======== Carga ICS / semana / polling ======== */
async function loadICS(){
  const url = C.icsUrl + (C.icsUrl.includes('?')?'&':'?') + 't=' + Date.now();
  try{
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const txt = await r.text();
    state.allEvents = parseICS(txt);
    document.getElementById('status').textContent = 'ICS OK';
  }catch(e){
    console.error('ICS error:', e);
    document.getElementById('status').textContent = 'ICS ERROR';
  }
}

function rebuildWeek(){
  state.week = groupByDayWeek(state.allEvents, new Date());
  state.dayIdx = 0;
  state.evIdx = 0;
  buildStageSequence();
  state.stageIdx = 0;
  paintStage();
}

async function boot(){
  await loadICS();
  rebuildWeek();
  // ciclo
  clearInterval(state.slideTimer);
  state.slideTimer = setInterval(advance, C.slideMs);
  // reloj
  setInterval(()=>{ renderClock(); }, 1000);
  // polling ICS
  setInterval(async ()=>{
    const before = (state.allEvents||[]).length;
    await loadICS();
    const after = (state.allEvents||[]).length;
    if (after !== before){
      rebuildWeek(); // si cambió el ICS, rearmamos semana
    }
  }, C.pollMs);
}
boot();

/* ======== SLEEP (nuevo, no rompe nada) ======== */
(function(){
  const S = (C && C.sleep) ? C.sleep : { enabled:false };
  if (!S.enabled) return;

  const overlay = document.getElementById('sleepOverlay');
  const msgEl   = overlay.querySelector('.msg');

  // Opacidad desde config (0..1)
  const dim = typeof S.dim === 'number' ? Math.min(1, Math.max(0, S.dim)) : 1;
  document.documentElement.style.setProperty('--sleep-opacity', String(dim));

  // Mensaje
  msgEl.textContent = S.overlayText || 'En modo descanso';

  // TZ: prioridad sleep.timeZone > MONITOR_CONFIG.timeZone > dispositivo
  const useTZ = S.timeZone || C.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

  // Parse "HH:MM"
  function toMinutes(hm){
    if (!hm) return 0;
    const m = String(hm).match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return 0;
    const H = Math.min(23, Math.max(0, parseInt(m[1],10)));
    const M = Math.min(59, Math.max(0, parseInt(m[2],10)));
    return H*60 + M;
  }

  const startMin = toMinutes(S.start || '22:00');
  const endMin   = toMinutes(S.end   || '06:00');
  const days     = Array.isArray(S.days) && S.days.length ? S.days : [0,1,2,3,4,5,6]; // 0=Dom

  let sleeping = false;

  function nowLocal(){
    return new Date(new Date().toLocaleString('en-US', { timeZone: useTZ }));
  }

  function isSleepWindow(d){
    const dow = d.getDay();
    if (!days.includes(dow)) return false;
    const mins = d.getHours()*60 + d.getMinutes();

    if (startMin === endMin) return false;      // sin ventana
    if (startMin < endMin) {                    // misma noche (ej. 22:00–23:30)
      return mins >= startMin && mins < endMin;
    } else {                                    // cruza medianoche (ej. 22:00–06:00)
      return mins >= startMin || mins < endMin;
    }
  }

  function applySleep(on){
    if (on && !sleeping){
      overlay.classList.add('active');
      sleeping = true;
      window.dispatchEvent(new CustomEvent('sleep:enter'));
    } else if (!on && sleeping){
      overlay.classList.remove('active');
      sleeping = false;
      window.dispatchEvent(new CustomEvent('sleep:exit'));
    }
  }

  function tick(){
    try{
      const d = nowLocal();
      applySleep( isSleepWindow(d) );
    }catch(_){}
  }

  // primera evaluación + polling
  tick();
  setInterval(tick, Math.max(15000, S.pollMs || 60000));
})();
</script>
</body>
</html>
